# Alert Rules for Memory MCP Server
# Version: 1.0.0
#
# Critical Alerts (PagerDuty):
#   - High error rate (>5% for 5 min)
#   - P95 latency >200ms
#   - Service down
#   - Certificate expiring (<14 days)
#   - Consolidation failure
#   - High auth failure rate (>10 failures/min)

groups:
  # ============================================================================
  # Service Availability Alerts
  # ============================================================================
  - name: service_availability
    rules:
      # MCP Server Down
      - alert: MCPServerDown
        expr: up{job="memory-mcp"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Memory MCP Server is down"
          description: "The Memory MCP Server has been unreachable for more than 1 minute."
          runbook_url: "https://wiki.example.com/runbooks/mcp-server-down"
          impact: "All memory operations will fail. Users cannot store or retrieve memories."

      # Redis Down
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Redis is down"
          description: "Redis has been unreachable for more than 1 minute. Rate limiting may be compromised."
          runbook_url: "https://wiki.example.com/runbooks/redis-down"
          impact: "Working memory and rate limiting unavailable. System will fail closed."

      # PostgreSQL Down
      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL has been unreachable for more than 1 minute."
          runbook_url: "https://wiki.example.com/runbooks/postgres-down"
          impact: "API key validation and audit logging unavailable."

      # Qdrant Down
      - alert: QdrantDown
        expr: up{job="qdrant"} == 0
        for: 2m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Qdrant vector database is down"
          description: "Qdrant has been unreachable for more than 2 minutes."
          runbook_url: "https://wiki.example.com/runbooks/qdrant-down"
          impact: "Semantic search unavailable. System will fall back to text search."

  # ============================================================================
  # Performance Alerts
  # ============================================================================
  - name: performance
    rules:
      # High Error Rate
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(mcp_requests_total{status="error"}[5m]))
            /
            sum(rate(mcp_requests_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "High error rate detected (>5%)"
          description: "Error rate has been above 5% for the past 5 minutes. Current rate: {{ $value | humanizePercentage }}"
          runbook_url: "https://wiki.example.com/runbooks/high-error-rate"
          impact: "Users experiencing failures. Check logs for root cause."

      # P95 Latency Exceeded
      - alert: HighP95Latency
        expr: |
          histogram_quantile(0.95,
            sum(rate(mcp_request_duration_seconds_bucket[5m])) by (le, tool)
          ) > 0.2
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "P95 latency exceeds 200ms target"
          description: "P95 latency for {{ $labels.tool }} has been above 200ms for 5 minutes. Current: {{ $value | humanizeDuration }}"
          runbook_url: "https://wiki.example.com/runbooks/high-latency"
          impact: "Users experiencing slow responses. Check database and embedding service."

      # Database Query Latency
      - alert: HighDatabaseLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(mcp_db_query_duration_seconds_bucket[5m])) by (le, db)
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Database query latency is high"
          description: "P95 latency for {{ $labels.db }} queries has exceeded 100ms for 5 minutes."
          runbook_url: "https://wiki.example.com/runbooks/db-latency"

  # ============================================================================
  # Security Alerts
  # ============================================================================
  - name: security
    rules:
      # High Authentication Failure Rate
      - alert: HighAuthFailureRate
        expr: |
          sum(rate(mcp_auth_attempts_total{status="failed"}[1m])) > 10
        for: 2m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "High authentication failure rate (>10/min)"
          description: "More than 10 authentication failures per minute for 2 minutes. Possible brute force attack."
          runbook_url: "https://wiki.example.com/runbooks/auth-failure-rate"
          impact: "Possible security incident. Review failed attempts and consider blocking IPs."

      # Possible Brute Force Attack
      - alert: PossibleBruteForce
        expr: |
          sum(rate(mcp_auth_attempts_total{status="failed"}[1m])) > 50
        for: 1m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Possible brute force attack detected"
          description: "More than 50 authentication failures per minute. Immediate investigation required."
          runbook_url: "https://wiki.example.com/runbooks/brute-force"
          impact: "Active attack in progress. Consider emergency IP blocks."

      # Rate Limiting Active
      - alert: ExcessiveRateLimiting
        expr: |
          sum(rate(mcp_rate_limit_hits_total[5m])) > 100
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Excessive rate limiting"
          description: "High volume of rate-limited requests. Review if limits are appropriate or if abuse is occurring."
          runbook_url: "https://wiki.example.com/runbooks/rate-limiting"

  # ============================================================================
  # Certificate Alerts
  # ============================================================================
  - name: certificates
    rules:
      # Certificate Expiring Soon (Warning)
      - alert: CertificateExpiringSoon
        expr: mcp_cert_expiry_days < 14 and mcp_cert_expiry_days >= 7
        for: 1h
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "SSL certificate expiring in less than 14 days"
          description: "Certificate expires in {{ $value }} days. Plan renewal soon."
          runbook_url: "https://wiki.example.com/runbooks/cert-renewal"

      # Certificate Expiring Critical
      - alert: CertificateExpiringCritical
        expr: mcp_cert_expiry_days < 7 and mcp_cert_expiry_days >= 0
        for: 0m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "SSL certificate expiring in less than 7 days"
          description: "Certificate expires in {{ $value }} days. Renew immediately!"
          runbook_url: "https://wiki.example.com/runbooks/cert-renewal-urgent"

      # Certificate Expired
      - alert: CertificateExpired
        expr: mcp_cert_expiry_days < 0
        for: 0m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "SSL certificate has expired!"
          description: "Certificate has been expired for {{ $value | abs }} days. Service may be inaccessible."
          runbook_url: "https://wiki.example.com/runbooks/cert-expired"

  # ============================================================================
  # Consolidation Pipeline Alerts
  # ============================================================================
  - name: consolidation
    rules:
      # Consolidation Failure
      - alert: ConsolidationFailure
        expr: increase(mcp_consolidation_failures_total[1h]) > 0
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Memory consolidation pipeline has failed"
          description: "The nightly consolidation pipeline has failed. Working memory may not be transferred to semantic memory."
          runbook_url: "https://wiki.example.com/runbooks/consolidation-failure"
          impact: "Recent memories may not be properly indexed for long-term retrieval."

      # Consolidation Duration Too Long
      - alert: ConsolidationDurationHigh
        expr: mcp_consolidation_duration_seconds > 3600
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Consolidation pipeline taking too long"
          description: "Consolidation has been running for {{ $value | humanizeDuration }}. Expected < 1 hour."
          runbook_url: "https://wiki.example.com/runbooks/consolidation-slow"

  # ============================================================================
  # Resource Alerts
  # ============================================================================
  - name: resources
    rules:
      # Low Cache Hit Rate
      - alert: LowCacheHitRate
        expr: mcp_cache_hit_rate < 0.5
        for: 15m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Cache hit rate is low"
          description: "Cache hit rate has been below 50% for 15 minutes. Current: {{ $value | humanizePercentage }}"
          runbook_url: "https://wiki.example.com/runbooks/cache-optimization"

      # Redis Memory High
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Redis memory usage is high"
          description: "Redis is using more than 90% of available memory. Consider scaling or eviction policies."
          runbook_url: "https://wiki.example.com/runbooks/redis-memory"

      # Disk Space Low
      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.1
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Disk space is running low"
          description: "Less than 10% disk space remaining on root filesystem."
          runbook_url: "https://wiki.example.com/runbooks/disk-space"
